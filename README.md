# LINE Bot with Google ADK - å¤šåŠŸèƒ½æ™ºæ…§åŠ©æ‰‹

åŸºæ–¼ Google ADK (Agent Development Kit) å’Œ Gemini 2.0 Flash æ¨¡å‹çš„å¤šåŠŸèƒ½ LINE æ©Ÿå™¨äººï¼Œæä¾›è±å¯Œçš„ç”Ÿæ´»æœå‹™å’Œå¨›æ¨‚åŠŸèƒ½ã€‚

## ğŸŒŸ ä¸»è¦åŠŸèƒ½

- **ğŸŒ¤ï¸ å¤©æ°£æŸ¥è©¢æœå‹™**
  - å…¨çƒå³æ™‚å¤©æ°£è³‡è¨Š (powered by wttr.in)
  - æœªä¾† 1-3 å¤©å¤©æ°£é å ±
  - æ™ºæ…§åŸå¸‚åç¨±è¾¨è­˜

- **ğŸ• æ™‚é–“æŸ¥è©¢æœå‹™**
  - å…¨çƒå„åŸå¸‚ç•¶å‰æ™‚é–“
  - æ™ºæ…§æ™‚å€åµæ¸¬ (powered by worldtimeapi.org)
  - é è¨­å°ç£æ™‚å€

- **ğŸ”— çŸ­ç¶²å€æœå‹™**
  - aiurl.tw çŸ­ç¶²å€ç”Ÿæˆ
  - è‡ªè¨‚ slug æ”¯æ´
  - è‡ªå‹•é‡è¤‡æª¢æ¸¬

- **ğŸ§  çŸ¥è­˜åº«æŸ¥è©¢**
  - **SETä¸‰ç«‹é›»è¦–** - ç¯€ç›®ã€è—äººã€æˆ²åŠ‡ç­‰ç›¸é—œè³‡è¨Š
  - **hihiå°è¦½å…ˆç”Ÿ** - å…¬è¦–å°èªç¯€ç›®è³‡è¨Š
  - FastGPT æ•´åˆçš„å°ˆæ¥­çŸ¥è­˜æŸ¥è©¢
  - ä¸Šä¸‹æ–‡æ„ŸçŸ¥å°è©±è¨˜æ†¶

- **âš–ï¸ æ³•å¾‹è«®è©¢æœå‹™**
  - å°ˆæ¥­æ³•å¾‹å•é¡Œè§£ç­”
  - åˆç´„æ¢æ–‡åˆ†æ
  - æ³•é™¢ç¨‹åºæŒ‡å¼•

- **ğŸ­ æ¢—åœ–ç”Ÿæˆå™¨**
  - AI é©…å‹•çš„è¿·å› åœ–ç‰‡ç”Ÿæˆ
  - æµè¡Œæ¢—åœ–ç¯„æœ¬
  - è‡ªè¨‚æ–‡å­—å…§å®¹

- **ğŸ¬ AI å½±ç‰‡ç”Ÿæˆ**
  - ComfyUI æ•´åˆçš„ AI å½±ç‰‡ç”Ÿæˆ
  - AI ä»£è¨€äººå½±ç‰‡è£½ä½œ
  - è‡ªå‹•å½±ç‰‡æ¨é€å’Œä¸‹è¼‰

- **ğŸ¥ å½±ç‰‡è½‰éŒ„æ‘˜è¦**
  - YouTube å½±ç‰‡å…§å®¹è½‰éŒ„
  - æ™ºæ…§æ‘˜è¦ç”Ÿæˆ
  - å¤šèªè¨€æ”¯æ´

- **ğŸŒ é˜¿ç¾æ—èªå­¸ç¿’**
  - æ¯æ—¥ä¸€å­—è©æ¨è–¦
  - åŸä½æ°‘èªè¨€æ–‡åŒ–æ¨å»£

- **ğŸ” ç¶²è·¯æœå°‹**
  - Google æœå°‹æ•´åˆ
  - å³æ™‚è³‡è¨ŠæŸ¥è©¢
  - æ™ºæ…§çµæœç¯©é¸

- **ğŸ“‹ ä»»å‹™ç‹€æ…‹æŸ¥è©¢**
  - é€šç”¨ ID æŸ¥è©¢ç³»çµ±
  - ä¸¦è¡Œä»»å‹™ç›£æ§
  - è‡ªå‹•çµæœæ¨é€

- **ğŸ¤– æ™ºæ…§å°è©±**
  - è‡ªç„¶èªè¨€ç†è§£
  - ç¹é«”ä¸­æ–‡å›æ‡‰
  - æƒ…å¢ƒæ„ŸçŸ¥å·¥å…·é¸æ“‡
  - ä¸»å‹•åŸ·è¡Œï¼Œæ¸›å°‘ç¢ºèªæ­¥é©Ÿ

## ğŸ› ï¸ æŠ€è¡“æ¶æ§‹

- **å¾Œç«¯æ¡†æ¶**: Python 3.10, FastAPI
- **AI æ¨¡å‹**: Google ADK, Gemini 2.0 Flash
- **è¨Šæ¯å¹³å°**: LINE Messaging API
- **å½±ç‰‡ç”Ÿæˆ**: ComfyUI, AnimateDiff
- **å®¹å™¨åŒ–**: Docker, Docker Compose
- **å¤–éƒ¨ API**:
  - wttr.in (å¤©æ°£)
  - worldtimeapi.org (æ™‚é–“)
  - aiurl.tw (çŸ­ç¶²å€)
  - FastGPT (çŸ¥è­˜åº«)
  - Google Search API (æœå°‹)
  - YouTube API (å½±ç‰‡è½‰éŒ„)

## Quick Start with Docker Compose

### Prerequisites

1. LINE Bot Channel (Channel Secret & Access Token)
2. Google AI Studio API Key
3. FastGPT API Key and URL (optional, for knowledge base features)
4. Docker and Docker Compose installed

### Setup

1. **Clone the repository**
   ```bash
   git clone https://github.com/your-repo/linebot-adk.git
   cd linebot-adk
   ```

2. **Configure environment variables**
   ```bash
   cp .env.example .env
   ```

   Edit `.env` file with your credentials:
   ```env
   # LINE Bot Configuration
   ChannelSecret=your_line_channel_secret
   ChannelAccessToken=your_line_channel_access_token

   # Google ADK Configuration
   GOOGLE_API_KEY=your_google_ai_studio_api_key

   # FastGPT Knowledge Base (Optional)
   FASTGPT_API_URL=your_fastgpt_api_url
   FASTGPT_API_KEY=your_fastgpt_api_key

   # ComfyUI Video Generation (Optional)
   COMFYUI_API_URL=http://your-comfyui-server:8188
   COMFYUI_TTS_API_URL=http://your-tts-server:8001/tts_url

   # Video Processing (Optional)
   VIDEO_API_BASE_URL=http://your-video-api-server

   # URL Shortening (Optional)
   AIURL_API_TOKEN=your_aiurl_token

   # Google Search (Optional)
   GOOGLE_CSE_ID=your_custom_search_engine_id
   GOOGLE_API_KEY_SEARCH=your_google_search_api_key
   ```

3. **Start the application**
   ```bash
   docker-compose up -d
   ```

4. **Check the service**
   ```bash
   curl http://localhost:8892/docs  # View API documentation
   docker-compose logs -f linebot-adk  # View logs
   ```

### LINE Bot Configuration

1. Go to [LINE Developers Console](https://developers.line.biz/console/)
2. Select your bot channel
3. Set the Webhook URL to: `https://your-domain.com/` (note the trailing slash)
4. Enable "Use webhook" and disable "Auto-reply messages"

## ğŸ“± ä½¿ç”¨ç¯„ä¾‹

ç™¼é€ä»¥ä¸‹è¨Šæ¯çµ¦ä½ çš„ LINE æ©Ÿå™¨äººï¼š

### ğŸŒ¤ï¸ å¤©æ°£æŸ¥è©¢
- "å°åŒ—å¤©æ°£å¦‚ä½•ï¼Ÿ"
- "æ±äº¬æ˜å¤©æœƒä¸‹é›¨å—ï¼Ÿ"
- "é«˜é›„æœªä¾†ä¸‰å¤©å¤©æ°£é å ±"

### ğŸ• æ™‚é–“æŸ¥è©¢
- "ç¾åœ¨å¹¾é»ï¼Ÿ"
- "ç´ç´„ç¾åœ¨å¹¾é»ï¼Ÿ"
- "ä»Šå¤©å¹¾è™Ÿï¼Ÿ"

### ğŸ”— çŸ­ç¶²å€
- ç›´æ¥ç™¼é€ä»»ä½•ç¶²å€ï¼š"https://github.com/example/repo"
- è‡ªè¨‚åç¨±ï¼š"å¹«æˆ‘ç¸®çŸ­ç¶²å€ï¼Œåç¨±ç”¨ my-link"

### ğŸ§  çŸ¥è­˜åº«æŸ¥è©¢
**SETä¸‰ç«‹é›»è¦–ï¼š**
- "ä¸‰ç«‹åœ¨å“ªè£¡ï¼Ÿ"
- "ä¸‰ç«‹æœ‰ä»€éº¼ç¯€ç›®ï¼Ÿ"
- "ç‚®ä»”è²æ¼”å“¡æœ‰èª°ï¼Ÿ"

**hihiå°è¦½å…ˆç”Ÿï¼š**
- "hihiå…ˆç”Ÿæ˜¯èª°ï¼Ÿ"
- "ç¯€ç›®å…§å®¹æ˜¯ä»€éº¼ï¼Ÿ"
- "æœ‰å¤šå°‘é›†ï¼Ÿ"

### âš–ï¸ æ³•å¾‹è«®è©¢
- "ç§Ÿæˆ¿åˆç´„è¦æ³¨æ„ä»€éº¼ï¼Ÿ"
- "äº¤é€šäº‹æ•…è©²æ€éº¼è™•ç†ï¼Ÿ"
- "å‹å‹•æ³•è¦å®šåŠ ç­è²»å¦‚ä½•è¨ˆç®—ï¼Ÿ"

### ğŸ­ æ¢—åœ–ç”Ÿæˆ
- "ç”Ÿæˆä¸€å€‹è²“å’ªæ¢—åœ–"
- "å¹«æˆ‘åšä¸€å€‹ã€Œæˆ‘å¤ªé›£äº†ã€çš„åœ–"
- "éš¨ä¾¿ä¾†å€‹æç¬‘åœ–ç‰‡"

### ğŸ¬ AI å½±ç‰‡ç”Ÿæˆ
- "å¹«æˆ‘ç”¨å½±ç‰‡å›è¦†é€™å€‹å•é¡Œ"
- "ç”Ÿæˆä¸€æ®µAIå½±ç‰‡èªªæ˜é€™ä»¶äº‹"
- "åšå€‹å½±ç‰‡ä»‹ç´¹ä¸‰ç«‹é›»è¦–"

### ğŸ¥ å½±ç‰‡è½‰éŒ„æ‘˜è¦
- ç™¼é€ YouTube é€£çµ
- "å¹«æˆ‘è½‰éŒ„é€™å€‹å½±ç‰‡"
- "é€™å€‹å½±ç‰‡åœ¨è¬›ä»€éº¼ï¼Ÿ"

### ğŸŒ é˜¿ç¾æ—èªå­¸ç¿’
- "æ¯æ—¥ä¸€å­—"
- "é˜¿ç¾æ—èªå­¸ç¿’"
- "ä»Šå¤©æ•™ä»€éº¼å­—ï¼Ÿ"

### ğŸ” ç¶²è·¯æœå°‹
- "æœå°‹å°ç£æœ€æ–°æ–°è"
- "æŸ¥è©¢ ChatGPT æœ€æ–°åŠŸèƒ½"
- "æ‰¾æ‰¾çœ‹ Python æ•™å­¸"

### ğŸ“‹ ä»»å‹™æŸ¥è©¢
- ç›´æ¥ç™¼é€ä»»å‹™ IDï¼š`550e8400-e29b-41d4-a716-446655440000`
- "æŸ¥è©¢ä»»å‹™ç‹€æ…‹"
- "æˆ‘çš„å½±ç‰‡ç”Ÿæˆå¥½äº†å—ï¼Ÿ"

## Development

### Local Development (without Docker)

```bash
# Install dependencies
pip install -r requirements.txt

# Set environment variables
export ChannelSecret=your_channel_secret
export ChannelAccessToken=your_channel_access_token
export GOOGLE_API_KEY=your_google_api_key
export FASTGPT_API_URL=your_fastgpt_api_url  # Optional
export FASTGPT_API_KEY=your_fastgpt_api_key  # Optional

# Run the application
uvicorn main:app --host=0.0.0.0 --port=8892 --reload
```

### Testing

```bash
# Test the webhook endpoint
curl -X POST http://localhost:8892/ \
  -H "Content-Type: application/json" \
  -d '{"test": "message"}'

# View API documentation
open http://localhost:8892/docs
```

## Docker Commands

```bash
# Build and start services
docker-compose up -d

# View logs
docker-compose logs -f linebot-adk

# Restart services
docker-compose restart

# Stop services
docker-compose down

# Rebuild after code changes
docker-compose down
docker-compose build
docker-compose up -d
```

## Configuration

### ğŸ”§ ç’°å¢ƒè®Šæ•¸è¨­å®š

| è®Šæ•¸åç¨± | èªªæ˜ | å¿…è¦æ€§ | é è¨­å€¼ |
|----------|------|--------|--------|
| `ChannelSecret` | LINE Channel Secret | âœ… å¿…è¦ | - |
| `ChannelAccessToken` | LINE Channel Access Token | âœ… å¿…è¦ | - |
| `GOOGLE_API_KEY` | Google AI Studio API Key | âœ… å¿…è¦ | - |
| `FASTGPT_API_URL` | FastGPT API ç«¯é» URL | âŒ é¸ç”¨ | - |
| `FASTGPT_API_KEY` | FastGPT API èªè­‰é‡‘é‘° | âŒ é¸ç”¨ | - |
| `COMFYUI_API_URL` | ComfyUI æœå‹™å™¨ URL | âŒ é¸ç”¨ | http://localhost:8188 |
| `COMFYUI_TTS_API_URL` | TTS æœå‹™å™¨ URL | âŒ é¸ç”¨ | - |
| `VIDEO_API_BASE_URL` | å½±ç‰‡è™•ç† API åŸºç¤ URL | âŒ é¸ç”¨ | - |
| `AIURL_API_TOKEN` | aiurl.tw API Token | âŒ é¸ç”¨ | - |
| `GOOGLE_CSE_ID` | Google è‡ªè¨‚æœå°‹å¼•æ“ ID | âŒ é¸ç”¨ | - |
| `GOOGLE_API_KEY_SEARCH` | Google æœå°‹ API Key | âŒ é¸ç”¨ | - |

### Customizing Agent Behavior

Edit the `instruction` parameter in `main.py` to customize the agent's behavior:

```python
instruction=(
    "I am a specialized assistant providing four services: weather, time, URL shortening, and knowledge base queries.\n"
    "Respond concisely in Traditional Chinese without asking too many confirmation questions.\n"
    "For knowledge base queries, I specialize in Public TV hihi character information."
)
```

## Deployment

### Production Deployment

1. **Set up a reverse proxy** (nginx, Cloudflare, etc.)
2. **Configure HTTPS** for the webhook URL
3. **Set up monitoring** and log management
4. **Configure auto-restart** policies
5. **Set up backup** for environment configurations

### Cloud Deployment

The application can be deployed to various cloud platforms:
- Google Cloud Run
- AWS ECS/Fargate
- Azure Container Instances
- Railway, Render, or similar PaaS platforms

## Troubleshooting

### Common Issues

1. **Webhook returns 404**
   - Ensure webhook URL ends with `/` (e.g., `https://domain.com/`)
   - Check that the service is running on the correct port

2. **Invalid signature errors**
   - Verify `ChannelSecret` in environment variables
   - Check that webhook URL matches exactly

3. **AI responses not working**
   - Verify `GOOGLE_API_KEY` is valid
   - Check Google AI Studio quota and billing

4. **Weather/Time services failing**
   - Check internet connectivity from container
   - External APIs (wttr.in, worldtimeapi.org) might be temporarily unavailable

5. **Knowledge base not responding**
   - Verify `FASTGPT_API_KEY` and `FASTGPT_API_URL` are set correctly
   - Check FastGPT service availability
   - Knowledge base feature is optional; other functions will still work

### Debug Mode

Enable detailed logging by modifying the print statements in the code or check container logs:

```bash
docker-compose logs -f linebot-adk
```

## Contributing

1. Fork the repository
2. Create a feature branch: `git checkout -b feature-name`
3. Commit changes: `git commit -am 'Add some feature'`
4. Push to the branch: `git push origin feature-name`
5. Submit a pull request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- [Google ADK](https://developers.google.com/adk) for the agent framework
- [wttr.in](https://wttr.in) for weather data
- [worldtimeapi.org](https://worldtimeapi.org) for timezone information
- [aiurl.tw](https://aiurl.tw) for URL shortening service
- [FastGPT](https://fastgpt.in/) for knowledge base integration